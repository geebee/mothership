<!DOCTYPE html>
<html lang="en">
<head> <!-- {{{ -->
    <meta charset="utf-8">
    <title>mothership</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
</head> <!-- }}} -->
<body>
    <div id="navBarFrame" class="navbar"> <!-- {{{ -->
        <div id="navBarInner" class="navbar-inner">
            <a id="navTitle" class="brand" href="#">mothership...</a>
            <ul id="navItems" class="nav">
                <li class="active" id="home"><a href="#home">Home</a></li>
                <li id="findConfig" data-bind="click: focusSearch"><a href="#findConfig">Find a Config</a></li>
                <li id="addConfig"><a href="#addConfig">Add a Config</a></li>
            </ul>
            <div id="searchContainer" class="pull-right">
                <ul class="nav"><li class="divider-vertical"></li></ul>
                <form id="searchBox" data-bind="submit: function(){return false;}" class="navbar-search" autocomplete="off">
                    <input type="text" id="propertySearch" class="search-query input-xlarge" data-provide="typeahead" placeholder="search..." data-bind="hasfocus:searchFocused"/>
                    <i class="icon-search" style="position: relative; left: -12%;"></i>
                </form> <!-- #searchBox -->
            </div> <!-- #searchContainer -->
        </div> <!-- #navBarInner.navbar-inner -->
    </div> <!-- #navBarFrame.navbar }}} -->
    <br/>
    <div id="guestHome" data-bind="style: {display: guestHome}" class="pageContainer row-fluid span12"></div>
    <div id="userHome" data-bind="style: {display: userHome}" class="pageContainer row-fluid span12"></div>
    <div id="editConfig" data-bind="style: {display: confLoaded}" class="pageContainer row-fluid span12"></div>

</body>
<!-- {{{ Load Javascript at the end to allow for better request pipelining -->
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script type="text/javascript" src="js/knockout-2.1.0.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<!--
<script type="text/javascript" src="js/d3.v2.min.js"></script>
<script type="text/javascript" src="js/d3.layout.cloud.js"></script>
-->
<!-- }}} -->
<!--{{{ document.ready -->
<script type="text/javascript">
    $(document).ready(function() {
        $.getScript("js/ko-utils/bindingHandlers.js", function() {
            console.log("bindingHandlers loaded.");
            $.getScript("js/ko-utils/protectedObservable.js", function() {
                console.log("protectedObservable util loaded.");
                $.getScript("js/models/navBar.js", function() {
                    console.log("About to bind NavBarViewModel to #navBarFrame.");
                    ko.applyBindings(nbVM = new NavBarViewModel(), document.getElementById("navBarFrame"));

                    $.getScript("js/models/guestDashboard.js", function() {
                        console.log("Loading guest home template");
                        $('#guestHome').load("/templates/guestDashboard.html", function() {
                            console.log("About to bind GuestDashboardViewModel to #guestHome.");
                            ko.applyBindings(gdVM = new GuestDashboardViewModel(), document.getElementById("guestHome"));
                            gdVM.totalConfsAndRevisions();
                        });

                        $.getScript("js/models/userDashboard.js", function() {
                            $('#userHome').load("/templates/userDashboard.html", function() {
                                console.log("About to bind UserDashboardViewModel to #userHome.");
                                //For now, there is no difference, so just bind a second instance of the guest dashboard
                                //ko.applyBindings(new UserDashboardViewModel(), document.getElementById("userHome"));
                                ko.applyBindings(udVM = new GuestDashboardViewModel(), document.getElementById("userHome"));
                            });

                            $.getScript("js/models/conf.js", function() {
                                console.log("ConfViewModel ready for binding.");
                                $('#editConfig').load("/templates/config.html", function() {
                                    console.log("Binding ConfViewModel now.");
                                    ko.applyBindings(cVM = new ConfViewModel(), document.getElementById("editConfig"));
                                });
                            });
                        })
                    });
                });

                $("#navItems li a").click(function(e) {
                    if (!$(this).hasClass('active')) {
                        $(this).parent().parent().children().filter(".active").removeClass("active");
                        $(this).parent().addClass('active');
                        location.hash = $(this).attr('href');
                        //console.log($(this).parent().attr("id"));
                    }
                    e.preventDefault();
                });

                var labels, mapped;
                $('#propertySearch').typeahead({
                    minLength: 3,
                    source: function (query, process) {
                        $.get('/search', { query: query }, function (data) {
                            labels = [];
                            mapped = {};

                            $.each(data.found, function(i, item) {
                                var tempLabel = item.term + ' (' + item.friendlyName + ')';
                                mapped[tempLabel] = {friendlyName: item.friendlyName, label: tempLabel};
                                labels.push(tempLabel);
                            });

                            process(labels);
                        });
                    },
                    updater: function(item) { 
                        //console.log("typeahead.updater - item: %s", item);
                        var selfObj = mapped[item];
                        console.log("typeahead.updater - friendlyName: %s", selfObj.friendlyName);
                        cVM.loadConf(selfObj.friendlyName);

                        $("#navItems li").filter(".active").removeClass("active");
                        cVM.focusSearch(false);

                        //replace " (friendlyName)" with nothing in the actual selection
                        //this avoids unnecessary searches by backspacing through extraneous text
                        return item.replace(/ \(.*\)$/,"");
                    },
                    highlighter: function(item) {
                        var selfObj = mapped[item];
                        //do some modification of the output HTML for the list
                        return item.replace(/ (\(.*\))$/, " <strong>(<i>" + selfObj.friendlyName + "</i>)</strong>");
                    }
                });

                $("#versionMenu").on("click", "li a", function(e) {
                    if (!$(this).hasClass('active')) {
                        $("#versionMenu li").filter(".active").removeClass("active").children(":first").popover('hide');
                        $(this).parent().addClass('active');
                        location.hash = "#" + $(this).children(":first").attr("id");
                    }
                    e.preventDefault();
                });

                $("#signUpLink").on("click", function(){
                    $(this).fadeOut(function(){
                        $("#signUpForm").fadeIn();
                    });
                });
                
                $("#signInLink").on("click",function(){
                    $(this).fadeOut(function(){
                        $("#signInForm").fadeIn();
                    });
                });

            });
        });
    });
</script><!--}}}-->
<!-- {{{ *COMMENTED OUT* Word Cloud 
<script>
    var fill = d3.scale.category20();

    $.get('/wordCloud', null, function (data) {
        var cloudWords = data.found;        

        d3.layout.cloud().size([1024, 384])
            .words(cloudWords.map(function(d) {
                return {text: d, size: 30 + Math.random() * 90};
            }))
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            .font("Impact")
            .fontSize(function(d) { return d.size; })
            .on("end", draw)
            .start();
    });

    function draw(words) {
        d3.select("#wordCloud").append("svg")
            .attr("width", 1024)
            .attr("height", 384)
            .append("g")
            .attr("transform", "translate(512,192)")
            .selectAll("text")
            .data(words)
            .enter().append("text")
                .style("font-size", function(d) { return d.size + "px"; })
                .style("font-family", "Impact")
                .style("fill", function(d, i) { return fill(i); })
                .attr("text-anchor", "middle")
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) { return d.text; });
    }
</script> }}} -->
</html>
